<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Website Evaluation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Add Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
      <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#6366f1",
                        secondary: "#8b5cf6",
                        accent: "#06b6d4",
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        .slide-in-up { animation: slideInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .score-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideInUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tracker-item { transition: all 0.4s ease-in-out; opacity: 0.5; transform: scale(0.95); }
        .tracker-item.in-progress { opacity: 1; transform: scale(1.05); background-color: white; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .tracker-item.complete { opacity: 1; transform: scale(1); }
        .tracker-icon .spinner, .tracker-icon .checkmark { display: none; }
        .tracker-icon .pending-icon { display: block; }
        .in-progress .tracker-icon .spinner { display: block; animation: spin 1s linear infinite; }
        .in-progress .tracker-icon .pending-icon { display: none; }
        .complete .tracker-icon .checkmark { display: block; }
        .complete .tracker-icon .pending-icon { display: none; }
        .complete .tracker-text { text-decoration: line-through; color: #64748b; }
        @media print {
            body * { visibility: hidden; }
            #advanced-report-content, #advanced-report-content * { visibility: visible; }
            #advanced-report-content { position: absolute; left: 0; top: 0; width: 100%; padding: 2rem; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">

        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-slate-900 mb-2">Free Website Evaluation</h1>
            <p class="text-lg text-slate-600">Get an instant, AI-driven analysis of your website's design and user experience.</p>
        </header>

        <!-- Initial Screen -->
        <div id="start-screen" class="text-center bg-white p-8 rounded-2xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold mb-4">Get Your Free Website Analysis</h2>
            <p class="text-slate-600 mb-8 max-w-2xl mx-auto">Our AI will analyze your site's design, clarity, and how well it encourages visitors to take action.</p>
            <div class="max-w-md mx-auto space-y-4">
                <div>
                    <input id="website-url" type="url" placeholder="https://yourwebsite.com" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                    <p id="url-error" class="text-red-500 mt-2 text-sm text-left hidden"></p>
                </div>
                <div>
                    <input id="email" type="email" placeholder="you@email.com" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                    <p id="email-error" class="text-red-500 mt-2 text-sm text-left hidden">Please enter a valid email address.</p>
                </div>


                        <button id="start-btn" 
                            class="w-full bg-gradient-to-r from-primary to-secondary text-white px-8 py-4 rounded-xl text-lg font-semibold inline-flex items-center justify-center space-x-3 hover:scale-105 transition-transform shadow-lg hover:shadow-xl active:scale-95 active:brightness-90">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <span>Start Free Analysis</span>
                        </button>
                </div>
                <div class="mt-8 text-center text-sm text-gray-500">
                <div class="flex items-center justify-center space-x-4">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                    </svg>
                        No signup required
                    </div>
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                        </svg>
                        Results in minutes
                    </div>
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                        </svg>
                        100% Free
                    </div>
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                        </svg>
                        Powered by Google Gemini
                    </div>
                </div>
            </div>
            </div>
            
        </div>
        <!-- End Initial Screen -->

        <!-- Processing Screen -->
        <div id="processing-screen" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                <h2 class="text-2xl font-bold mb-2">AI Is Analyzing Your Website...</h2>
                <p class="text-slate-600 mb-8">This can take up to a minute. We're taking screenshots and sending them to the AI for evaluation.</p>
                <div id="tracker-container" class="space-y-3 max-w-md mx-auto text-left"></div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden text-center">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <!-- Display analyzed site URL -->
                <div id="results-url" class="mb-4 text-sm text-indigo-700 font-semibold break-all"></div>
                <h2 class="text-3xl font-bold mb-2">Your Analysis is Complete!</h2>
                <p class="text-slate-600 mb-8">Here's your website's initial score. For detailed recommendations, order the full report.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="relative flex justify-center items-center h-[18rem] w-[18rem] mx-auto">
                        <svg class="w-[18rem] h-[18rem] transform -rotate-90"><circle class="text-slate-200" stroke-width="16" stroke="currentColor" fill="transparent" r="80" cx="144" cy="144" /><circle id="score-circle" class="text-indigo-600 score-circle" stroke-width="16" stroke-linecap="round" stroke="currentColor" fill="transparent" r="80" cx="144" cy="144" /></svg>
                        <div class="absolute flex flex-col items-center left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                            <span id="overall-score-text" class="text-4xl font-extrabold text-slate-900">0</span>
                            <span class="text-slate-500 -mt-1 text-xl">Overall Score</span>
                        </div>
                    </div>
                    <div id="category-scores" class="space-y-4 text-left"></div>
                </div>
                <div id="feedback-section" class="mt-12 text-left border-t border-slate-200 pt-8">
                    <h3 class="text-2xl font-bold mb-4">Top Opportunities</h3>
                    <div id="feedback-list" class="space-y-6"></div>
                </div>
                <div class="mt-12 border-t border-slate-200 pt-8 text-center">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">Ready to Turn Insights into Action?</h3>
                    <p class="text-slate-600 max-w-xl mx-auto mb-6">This free report shows your biggest opportunities. The full, detailed report provides a step-by-step guide to fixing these issues and increasing conversions.</p>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                        <button id="restart-btn" class="w-full sm:w-auto bg-slate-200 text-slate-800 font-bold py-3 px-8 rounded-lg hover:bg-slate-300 transition">Analyze Another Site</button>
                        <button id="order-advanced-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105">Get the Full Report for $19.99</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Report Screen -->
        <div id="advanced-report-screen" class="hidden">
            <div id="purchase-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 fade-in">
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-8 text-center slide-in-up">
                    <h2 class="text-2xl font-bold mb-2">Unlock Your Detailed Report</h2>
                    <p class="text-slate-600 mb-6">Get the full, detailed report with all the steps to improve your site.</p>
                    <div class="bg-slate-100 p-6 rounded-lg mb-6">
                        <div class="flex justify-between items-center text-lg">
                            <span class="font-medium">Detailed Website Report</span>
                            <span class="font-bold text-indigo-600">$49.00</span>
                        </div>
                    </div>
                    <button id="simulate-purchase-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition">Simulate Secure Payment</button>
                    <button id="cancel-purchase-btn" class="mt-3 text-sm text-slate-500 hover:text-slate-700">Cancel and go back</button>
                </div>
            </div>
            <div id="advanced-report-content" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <!-- Display analyzed site URL -->
                <div id="advanced-url" class="mb-4 text-sm text-indigo-700 font-semibold break-all"></div>
                <div class="no-print flex justify-between items-center mb-8 border-b border-slate-200 pb-4">
                    <h2 class="text-3xl font-bold">Detailed Report</h2>
                    <div class="flex gap-3">
                        <button id="print-btn" class="flex items-center gap-2 bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Print</button>
                        <button id="download-btn" class="flex items-center gap-2 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Download PDF</button>
                    </div>
                </div>
                <div id="advanced-feedback-list" class="space-y-8"></div>
                <!-- **UPDATED**: New collapsible section for A/B Test Ideas -->
                <div id="ab-test-accordion" class="hidden no-print mt-12">
                    <button id="ab-test-toggle" class="w-full text-left font-bold text-xl p-4 bg-slate-100 rounded-lg flex justify-between items-center hover:bg-slate-200 transition">
                        <span>Bonus: A/B Test Ideas for Experts</span>
                        <svg id="ab-test-arrow" class="w-6 h-6 transition-transform" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div id="ab-test-content" class="hidden p-4 border border-t-0 border-slate-200 rounded-b-lg">
                        <div id="ab-test-list" class="space-y-3"></div>
                    </div>
                <!-- </div>
                <div class="no-print mt-12 p-8 bg-indigo-700 text-white rounded-2xl text-center shadow-2xl">
                    <h3 class="text-3xl font-extrabold mb-3">Ready to turn visitors into customers?</h3>
                    <p class="text-indigo-200 max-w-2xl mx-auto mb-6">This AI UX report is a powerful foundation! Our experts can build a custom plan leveraging your report data, tailored to your audience and business goals.</p>
                    <a href="https://www.withdesignspark.com" target="_blank" rel="noopener noreferrer" class="inline-block bg-white text-indigo-600 font-bold py-3 px-8 rounded-lg hover:bg-slate-100 transition-transform transform hover:scale-105 text-lg shadow-lg">Get in Touch</a>
                </div> -->
            </div>
        </div>
    </div>

    <!-- Modal Popovers for Policies -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
    <div id="modal-terms" class="fixed left-1/2 top-1/2 z-50 bg-white rounded-xl shadow-xl p-6 max-w-lg w-full -translate-x-1/2 -translate-y-1/2 hidden">
        <h3 class="text-xl font-bold mb-2">Terms of Use</h3>
        <p class="mb-2 text-gray-700 text-sm">This tool is provided as-is for personal and business use. No warranty is provided. By using this tool, you agree not to misuse the service or attempt to reverse engineer its functionality. All analysis is performed locally in your browser or via secure API calls. No website data is stored or shared beyond the evaluation process.</p>
        <button onclick="closeModal('terms')" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Close</button>
    </div>
    <div id="modal-privacy" class="fixed left-1/2 top-1/2 z-50 bg-white rounded-xl shadow-xl p-6 max-w-lg w-full -translate-x-1/2 -translate-y-1/2 hidden">
        <h3 class="text-xl font-bold mb-2">Privacy Policy</h3>
        <p class="mb-2 text-gray-700 text-sm">Your privacy is important. All website evaluations are processed securely. No personal data is collected or stored, except for your email if you request a report. We do not share your information with third parties. For questions, contact us via the website footer links.</p>
        <button onclick="closeModal('privacy')" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Close</button>
    </div>

    <footer class="flex flex-col items-center gap-2 text-center text-slate-600 bg-white rounded-xl px-4 py-4 mt-12">
        <div class="flex flex-wrap gap-4 mb-2">
            <a href="#" onclick="openModal('terms');return false;" class="hover:underline text-indigo-700">Terms of Use</a>
            <a href="#" onclick="openModal('privacy');return false;" class="hover:underline text-indigo-700">Privacy Policy</a>
            <a href="https://www.withdesignspark.com" target="_blank" rel="noopener noreferrer" class="hover:underline text-indigo-700">Contact</a>
        </div>
        <div class="text-xs">&copy; 2025 DesignSpark. All rights reserved.</div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const startScreen = document.getElementById('start-screen');
            const processingScreen = document.getElementById('processing-screen');
            const resultsScreen = document.getElementById('results-screen');
            const advancedReportScreen = document.getElementById('advanced-report-screen');
            const purchaseModal = document.getElementById('purchase-modal');
            const advancedReportContent = document.getElementById('advanced-report-content');
            const startBtn = document.getElementById('start-btn');
            const restartBtn = document.getElementById('restart-btn');
            const orderAdvancedBtn = document.getElementById('order-advanced-btn');
            const simulatePurchaseBtn = document.getElementById('simulate-purchase-btn');
            const cancelPurchaseBtn = document.getElementById('cancel-purchase-btn');
            const printBtn = document.getElementById('print-btn');
            const downloadBtn = document.getElementById('download-btn');
            const websiteUrlInput = document.getElementById('website-url');
            const emailInput = document.getElementById('email');
            const urlError = document.getElementById('url-error');
            const emailError = document.getElementById('email-error');
            const trackerContainer = document.getElementById('tracker-container');
            const overallScoreText = document.getElementById('overall-score-text');
            const scoreCircle = document.getElementById('score-circle');
            const categoryScoresContainer = document.getElementById('category-scores');
            const feedbackList = document.getElementById('feedback-list');
            const advancedFeedbackList = document.getElementById('advanced-feedback-list');
            const abTestAccordion = document.getElementById('ab-test-accordion');
            const abTestToggle = document.getElementById('ab-test-toggle');
            const abTestContent = document.getElementById('ab-test-content');
            const abTestArrow = document.getElementById('ab-test-arrow');
            const abTestList = document.getElementById('ab-test-list');
            const resultsUrl = document.getElementById('results-url');
            const advancedUrl = document.getElementById('advanced-url');
            
            // --- STATE ---
            let aiReportData = null;
            let analyzedUrl = ''; // Store the analyzed URL

            // --- FUNCTIONS ---
            function isValidUrl(string) { try { new URL(string); return true; } catch (_) { return false; } }
            function isValidEmail(email) { return /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(email).toLowerCase()); }

            async function startEvaluation() {
                let isValid = true;
                let urlToTest = websiteUrlInput.value.trim();
                // Add https:// if missing
                if (!/^https?:\/\//i.test(urlToTest) && urlToTest.length > 0) {
                    urlToTest = 'https://' + urlToTest;
                    websiteUrlInput.value = urlToTest; // Optionally update input for user
                }
                if (!isValidUrl(urlToTest)) { urlError.textContent = 'Please enter a valid URL.'; urlError.classList.remove('hidden'); websiteUrlInput.classList.add('border-red-500'); isValid = false; } else { urlError.classList.add('hidden'); websiteUrlInput.classList.remove('border-red-500'); }
                if (!isValidEmail(emailInput.value.trim())) { emailError.classList.remove('hidden'); emailInput.classList.add('border-red-500'); isValid = false; } else { emailError.classList.add('hidden'); emailInput.classList.remove('border-red-500'); }
                if (!isValid) return;

                analyzedUrl = urlToTest; // Save for later use

                startScreen.classList.add('fade-out');
                setTimeout(() => {
                    startScreen.classList.add('hidden');
                    processingScreen.classList.remove('hidden');
                    processingScreen.classList.add('fade-in');
                    runAutomatedChecks(urlToTest);
                }, 500);
            }

            function runTrackerAnimation(onComplete) {
                const checks = [
                    { id: 'screenshot-desktop', name: 'Checking out your website...' },
                    { id: 'screenshot-mobile', name: 'Looking at it on a phone...' },
                    { id: 'ai', name: 'Sending it to our big brain...' },
                    { id: 'parsing', name: 'Translating robot language...' },
                    { id: 'report', name: 'Making it look pretty...' }
                ];
                trackerContainer.innerHTML = '';
                checks.forEach(check => {
                    trackerContainer.innerHTML += `
                        <div id="tracker-${check.id}" class="tracker-item flex items-center p-4 bg-slate-100 rounded-lg">
                            <div class="tracker-icon w-6 h-6 mr-4 flex-shrink-0 flex items-center justify-center">
                                <svg class="pending-icon text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <svg class="spinner text-indigo-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                                <svg class="checkmark text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                            </div>
                            <span class="tracker-text font-medium text-slate-700">${check.name}</span>
                        </div>`;
                });

                let currentCheckIndex = 0;
                const interval = setInterval(() => {
                    if (currentCheckIndex > 0) document.getElementById(`tracker-${checks[currentCheckIndex - 1].id}`).classList.add('complete');
                    if (currentCheckIndex < checks.length) {
                        document.getElementById(`tracker-${checks[currentCheckIndex].id}`).classList.add('in-progress');
                        currentCheckIndex++;
                    } else {
                        clearInterval(interval);
                        onComplete();
                    }
                }, 1500);
            }

            async function runAutomatedChecks(urlToTest) {
                const apiPromise = fetch('api_handler.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: urlToTest })
                })
                .then(async response => {
                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        try {
                            const errorJson = JSON.parse(responseText);
                            throw new Error(errorJson.error || 'Network response was not ok');
                        } catch (e) {
                            throw new Error('Network response was not ok: ' + responseText);
                        }
                    }
                    
                    try {
                        return JSON.parse(responseText);
                    } catch (e) {
                        console.error("Failed to parse JSON:", e);
                        throw new Error("The AI returned a response that could not be read.");
                    }
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    aiReportData = data;
                })
                .catch(error => {
                    console.error('Error fetching AI data:', error);
                    urlError.textContent = `Error: ${error.message}`;
                    urlError.classList.remove('hidden');
                    setTimeout(restart, 100);
                });
                
                runTrackerAnimation(() => {
                    apiPromise.then(() => {
                        if(aiReportData) showResults();
                    }).catch(() => {
                         // Error is already handled
                    });
                });
            }

            function showResults() {
                processingScreen.classList.add('fade-out');
                setTimeout(() => {
                    processingScreen.classList.add('hidden');
                    resultsScreen.classList.remove('hidden');
                    resultsScreen.classList.add('fade-in');
                    // Show analyzed URL at top of results
                    if (resultsUrl && analyzedUrl) {
                        resultsUrl.textContent = "Analyzed Site: " + analyzedUrl;
                    }
                    displayInitialReport();
                }, 500);
            }

            function getScoreColor(percentage) {
                if (percentage === -1) return { bg: 'bg-slate-100', text: 'text-slate-500', bar: 'bg-slate-400' };
                if (percentage >= 85) return { bg: 'bg-green-100', text: 'text-green-800', bar: 'bg-green-500' };
                if (percentage >= 50) return { bg: 'bg-yellow-100', text: 'text-yellow-800', bar: 'bg-yellow-500' };
                return { bg: 'bg-red-100', text: 'text-red-800', bar: 'bg-red-500' };
            }

            function formatMetricName(name) {
                return name.replace(/([A-Z])/g, ' $1').trim();
            }

            function displayInitialReport() {
                if (!aiReportData || !aiReportData.basicReport || !aiReportData.basicReport.scores) {
                    urlError.textContent = `Error: The AI response was incomplete. Please try again.`;
                    urlError.classList.remove('hidden');
                    restart();
                    return;
                }

                const { overallScore, basicReport } = aiReportData;
                const { scores, topOpportunities } = basicReport;
                
                const metricDescriptions = {
                    HeroClarity: "How clear is your main message?",
                    VisualDesignLayout: "How professional does it look?",
                    CallToAction: "Is it obvious what to do next?",
                    ReadabilityTypography: "Is the text easy to read?",
                    SocialProofTrust: "Does your site build trust?"
                };

                const scoresArray = Object.keys(scores).map(key => ({ metric: key, score: scores[key] }));

                categoryScoresContainer.innerHTML = '';
                scoresArray.forEach((cat, index) => {
                    const colors = getScoreColor(cat.score);
                    const scoreText = cat.score === -1 ? 'N/A' : cat.score;
                    const formattedName = formatMetricName(cat.metric);
                    categoryScoresContainer.innerHTML += `
                        <div class="slide-in-up" style="animation-delay: ${index * 100}ms">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-semibold">${formattedName}</span>
                                <span class="text-sm font-bold ${colors.bg} ${colors.text} px-2.5 py-1 rounded-md">${scoreText}</span>
                            </div>
                            <p class="text-sm text-slate-500 text-left mb-2">${metricDescriptions[cat.metric] || ''}</p>
                            <div class="w-full bg-slate-200 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full progress-bar-fill ${colors.bar}" style="width: 0%"></div>
                            </div>
                        </div>`;
                });

                feedbackList.innerHTML = '';
                if (Array.isArray(topOpportunities) && topOpportunities.length > 0) {
                    topOpportunities.forEach(opp => {
                        feedbackList.innerHTML += `<div class="flex gap-4"><div class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center font-bold text-lg">💡</div><div><p class="text-slate-600">${opp}</p></div></div>`;
                    });
                } else {
                    feedbackList.innerHTML = `<p class="text-slate-600">Great job! The AI didn't find any major opportunities for improvement in its initial check.</p>`;
                }
                
                setTimeout(() => {
                    document.querySelectorAll('#category-scores .progress-bar-fill').forEach((bar, index) => {
                        if (scoresArray[index]) {
                            const score = scoresArray[index].score;
                            bar.style.width = score === -1 ? '100%' : `${score}%`;
                        }
                    });
                }, 200);

                let currentScore = 0;
                const scoreInterval = setInterval(() => {
                    if (currentScore >= overallScore) { clearInterval(scoreInterval); overallScoreText.textContent = overallScore; } else { currentScore++; overallScoreText.textContent = currentScore; }
                }, 20);

                const circle = scoreCircle;
                const circumference = circle.r.baseVal.value * 2 * Math.PI;
                const offset = circumference - (overallScore / 100) * circumference;
                setTimeout(() => { circle.style.strokeDashoffset = offset; }, 200);
            }

            function showAdvancedReportFlow() {
                resultsScreen.classList.add('fade-out');
                setTimeout(() => {
                    resultsScreen.classList.add('hidden');
                    advancedReportScreen.classList.remove('hidden');
                    purchaseModal.classList.remove('hidden');
                    // Show analyzed URL at top of advanced report
                    if (advancedUrl && analyzedUrl) {
                        advancedUrl.textContent = "Analyzed Site: " + analyzedUrl;
                    }
                }, 500);
            }

            function generateAdvancedFeedback() {
                if (!aiReportData || !aiReportData.advancedReport || !aiReportData.advancedReport.scores || !aiReportData.advancedReport.advancedFeedback) {
                    advancedFeedbackList.innerHTML = `<p class="text-red-500">Could not display the detailed report due to an issue with the AI response.</p>`;
                    return;
                }
                const { scores, advancedFeedback, abTestIdeas } = aiReportData.advancedReport;
                
                const metricIcons = {
                    HeroClarity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
                    VisualDesignLayout: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>`,
                    CallToAction: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 15h14"/><path d="m12 5 7 10H5Z"/></svg>`,
                    ReadabilityTypography: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg>`,
                    SocialProofTrust: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
                    HeroTrustSignals: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
                    PersuasiveCopy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>`,
                    AttentionRatio: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 20v-4M18 20v-2"/></svg>`,
                    NavigationClarity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
                    AccessibilityContrast: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 18a6 6 0 0 0 0-12v12z"/></svg>`,
                    MobileResponsiveHints: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>`,
                };
                
                const feedbackArray = Object.keys(advancedFeedback).map(key => ({ category: key, ...advancedFeedback[key] }));

                advancedFeedbackList.innerHTML = '';
                feedbackArray.forEach(catFeedback => {
                    const scoreValue = scores[catFeedback.category];
                    const colors = getScoreColor(scoreValue);
                    const scoreText = scoreValue === -1 ? 'N/A' : scoreValue;
                    const formattedName = formatMetricName(catFeedback.category);
                    const icon = metricIcons[catFeedback.category] || metricIcons.VisualDesignLayout; // Default icon

                    advancedFeedbackList.innerHTML += `
                        <div class="p-6 border border-slate-200 rounded-xl">
                            <div class="flex gap-6 items-start">
                                <div class="flex-shrink-0 flex flex-col items-center">
                                    <div class="w-16 h-16 rounded-full ${colors.bg} ${colors.text} flex-shrink-0 flex items-center justify-center font-bold text-2xl">${scoreText}</div>
                                    <div class="w-12 h-12 mt-3 flex items-center justify-center text-slate-500">${icon}</div>
                                </div>
                                <div class="flex-grow">
                                    <h3 class="text-2xl font-bold">${formattedName}</h3>
                                    <div class="mt-2 text-slate-700 leading-relaxed space-y-3">
                                        <p>${catFeedback.feedback}</p>
                                        <p class="p-3 bg-slate-50 border-l-4 border-slate-200 italic"><span class="font-semibold not-italic">Example:</span> ${catFeedback.example}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                if (Array.isArray(abTestIdeas) && abTestIdeas.length > 0) {
                    abTestAccordion.classList.remove('hidden');
                    abTestList.innerHTML = '';
                    abTestIdeas.forEach(idea => {
                        abTestList.innerHTML += `<div class="bg-slate-100 p-3 rounded-lg flex items-start gap-3"><span class="text-indigo-500 font-bold">Test:</span><p class="text-slate-700">${idea}</p></div>`;
                    });
                } else {
                    abTestAccordion.classList.add('hidden');
                }
            }
            
            function downloadReport() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                if (!aiReportData) {
                    doc.text("No report data available.", 10, 10);
                    doc.save('AI-Website-Report.pdf');
                    return;
                }

                const { overallScore, advancedReport } = aiReportData;
                const { scores, advancedFeedback, abTestIdeas } = advancedReport;

                let yPos = 20;
                const leftMargin = 15;
                const rightMargin = 195;
                const lineSpacing = 7;

                // Add analyzed URL at the top
                if (analyzedUrl) {
                    doc.setFontSize(11);
                    doc.setTextColor(54, 78, 163);
                    doc.text(`Analyzed Site: ${analyzedUrl}`, leftMargin, yPos);
                    yPos += lineSpacing * 1.5;
                    doc.setTextColor(0, 0, 0);
                }

                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text('AI-Powered Website Evaluation', leftMargin, yPos);
                yPos += lineSpacing * 2;

                doc.setFontSize(16);
                doc.text(`Overall Score: ${overallScore}`, leftMargin, yPos);
                yPos += lineSpacing * 2;

                const feedbackArray = Object.keys(advancedFeedback).map(key => ({ category: key, ...advancedFeedback[key] }));

                feedbackArray.forEach(catFeedback => {
                    if (yPos > 260) { // Check if new page is needed
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const scoreValue = scores[catFeedback.category];
                    const scoreText = scoreValue === -1 ? 'N/A' : scoreValue;
                    const formattedName = formatMetricName(catFeedback.category);
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${formattedName} (Score: ${scoreText})`, leftMargin, yPos);
                    yPos += lineSpacing;

                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    
                    const feedbackLines = doc.splitTextToSize(catFeedback.feedback, rightMargin - leftMargin);
                    doc.text(feedbackLines, leftMargin, yPos);
                    yPos += feedbackLines.length * lineSpacing;

                    const exampleLines = doc.splitTextToSize(`Example: ${catFeedback.example}`, rightMargin - leftMargin - 5);
                    doc.setFont('helvetica', 'italic');
                    doc.text(exampleLines, leftMargin + 5, yPos);
                    yPos += exampleLines.length * lineSpacing + (lineSpacing * 1.5);
                });

                if (Array.isArray(abTestIdeas) && abTestIdeas.length > 0) {
                     if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('A/B Test Ideas', leftMargin, yPos);
                    yPos += lineSpacing;
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    abTestIdeas.forEach(idea => {
                        const ideaLines = doc.splitTextToSize(`- ${idea}`, rightMargin - leftMargin);
                        doc.text(ideaLines, leftMargin, yPos);
                        yPos += ideaLines.length * lineSpacing;
                    });
                }

                // Add blurb at the bottom of the last page
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                yPos = Math.max(yPos, 250); // Push to bottom if not already
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(54, 78, 163);
                doc.textWithLink('Need more website help? Visit withsparkdesign.com', leftMargin, yPos + 15, { url: 'https://www.withsparkdesign.com' });
                doc.setTextColor(0, 0, 0);

                doc.save('AI-Website-Report.pdf');
            }

            function restart() {
                const currentScreen = document.querySelector('#app > div:not(.hidden)');
                if (!currentScreen) return;
                currentScreen.classList.add('fade-out');
                setTimeout(() => {
                    currentScreen.classList.add('hidden');
                    startScreen.classList.remove('hidden', 'fade-out');
                    startScreen.classList.add('fade-in');
                    websiteUrlInput.value = '';
                    emailInput.value = '';
                    aiReportData = null;
                    urlError.classList.add('hidden');
                    emailError.classList.add('hidden');
                    // Reset results screen UI
                    overallScoreText.textContent = '0';
                    scoreCircle.style.strokeDashoffset = scoreCircle.r.baseVal.value * 2 * Math.PI;
                    categoryScoresContainer.innerHTML = '';
                    feedbackList.innerHTML = '';
                    // Reset progress bars if any remain
                    document.querySelectorAll('#category-scores .progress-bar-fill').forEach(bar => {
                        bar.style.width = '0%';
                    });
                    // Hide advanced report content and modal
                    if (advancedReportContent) advancedReportContent.classList.add('hidden');
                    if (purchaseModal) purchaseModal.classList.add('hidden');
                    if (abTestAccordion) abTestAccordion.classList.add('hidden');
                    if (abTestList) abTestList.innerHTML = '';
                    if (advancedFeedbackList) advancedFeedbackList.innerHTML = '';
                }, 500);
            }

            // --- STRIPE CONFIG ---
            // Replace with your real Stripe publishable key and price ID
            const STRIPE_PUBLIC_KEY = 'pk_live_51QLvcZFTB7fZkt2EsJCLa3B62zm0CAI7bhaMmF399YZMgUagoJCJsvLdyt6hiUG9FPtAezkF415RaRehrDUqwAZI00n8jKwfD0'; // TODO: Replace with your Stripe public key
            const STRIPE_PRICE_ID = 'price_1RiXQQFTB7fZkt2EnO1MqYDO'; // TODO: Replace with your Stripe Price ID for "Advanced Website UX Report"

            // Stripe Checkout handler
            function handleStripeCheckout() {
                const stripe = Stripe(STRIPE_PUBLIC_KEY);
                stripe.redirectToCheckout({
                    lineItems: [{ price: STRIPE_PRICE_ID, quantity: 1 }],
                    mode: 'payment',
                    successUrl: window.location.href + '?checkout=success',
                    cancelUrl: window.location.href + '?checkout=cancel',
                    customerEmail: document.getElementById('email').value.trim() || undefined
                }).then(function (result) {
                    if (result.error) {
                        alert('Stripe error: ' + result.error.message);
                    }
                });
            }

            // --- EVENT LISTENERS ---
            startBtn.addEventListener('click', startEvaluation);
            restartBtn.addEventListener('click', restart);
            orderAdvancedBtn.addEventListener('click', showAdvancedReportFlow);
            cancelPurchaseBtn.addEventListener('click', () => {
                advancedReportScreen.classList.add('hidden');
                resultsScreen.classList.remove('hidden', 'fade-out');
                resultsScreen.classList.add('fade-in');
            });
            simulatePurchaseBtn.addEventListener('click', () => {
                // Simulate purchase: hide modal, show advanced report content, generate feedback
                purchaseModal.classList.add('hidden');
                advancedReportContent.classList.remove('hidden');
                if (typeof generateAdvancedFeedback === 'function') {
                    generateAdvancedFeedback();
                }
            });
            printBtn.addEventListener('click', () => window.print());
            downloadBtn.addEventListener('click', downloadReport);
            abTestToggle.addEventListener('click', () => {
                abTestContent.classList.toggle('hidden');
                abTestArrow.classList.toggle('rotate-180');
            });
        });

        // --- SHOW ADVANCED REPORT AFTER STRIPE CHECKOUT ---
        (function () {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('checkout') === 'success') {
                // Hide all screens
                document.querySelectorAll('#app > div').forEach(div => div.classList.add('hidden'));
                // Show advanced report screen and content
                const advancedReportScreen = document.getElementById('advanced-report-screen');
                const purchaseModal = document.getElementById('purchase-modal');
                const advancedReportContent = document.getElementById('advanced-report-content');
                const advancedUrl = document.getElementById('advanced-url');
                advancedReportScreen.classList.remove('hidden');
                purchaseModal.classList.add('hidden');
                advancedReportContent.classList.remove('hidden');
                // Generate advanced feedback if data is available
                if (typeof generateAdvancedFeedback === 'function') {
                    generateAdvancedFeedback();
                }
                // Show analyzed URL if available
                if (advancedUrl && window.analyzedUrl) {
                    advancedUrl.textContent = "Analyzed Site: " + window.analyzedUrl;
                }
            }
        })();

        // Modal logic for policies
        function openModal(type) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-' + type).classList.remove('hidden');
        }
        function closeModal(type) {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('modal-' + type).classList.add('hidden');
        }
    </script>
</body>
</html>
